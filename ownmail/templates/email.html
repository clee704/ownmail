{% extends "base.html" %}

{% block title %}{{ subject }} - ownmail{% endblock %}

{% block content %}
    <div class="email-detail">
        <div class="email-header">
            <div class="email-header-top">
                <h2>{{ subject or '(No subject)' }}</h2>
                <div class="email-menu">
                    <button class="email-menu-btn" onclick="toggleEmailMenu(event)"><span></span><span></span><span></span></button>
                    <div class="email-menu-dropdown" id="email-menu-dropdown">
                        <a href="/raw/{{ message_id }}">Show original</a>
                        <a href="/download/{{ message_id }}">Download message</a>
                    </div>
                </div>
            </div>
            <div class="email-header-row">
                <span class="email-header-label">From:</span>
                <span class="email-header-value">{% if sender_name and sender_email %}
                    {{ sender_name }}
                    &lt;<a href="/search?q=from:{{ sender_email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading(event)">{{ sender_email }}</a>&gt;
                {% elif sender_email %}
                    <a href="/search?q=from:{{ sender_email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading(event)">{{ sender_email }}</a>
                {% else %}
                    {{ sender }}
                {% endif %}</span>
            </div>
            <div class="email-header-row">
                <span class="email-header-label">To:</span>
                <span class="email-header-value">{% for rcpt in recipients_parsed %}
                    {% if not loop.first %}, {% endif %}
                    {% if rcpt.name and rcpt.email %}
                        {{ rcpt.name }}
                        &lt;<a href="/search?q=to:{{ rcpt.email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading(event)">{{ rcpt.email }}</a>&gt;
                    {% elif rcpt.email %}
                        <a href="/search?q=to:{{ rcpt.email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading(event)">{{ rcpt.email }}</a>
                    {% else %}
                        {{ rcpt.raw }}
                    {% endif %}
                {% endfor %}</span>
            </div>
            <div class="email-header-row">
                <span class="email-header-label">Date:</span><span class="email-header-value">{{ date }}</span>
            </div>
            {% if labels %}
            <div class="labels">
                {% for label in labels %}
                <a href="/search?q=label:{{ label | urlencode }}&sort=date_desc" class="label clickable-label" onclick="showLoading(event)">{{ label }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="email-content-area">
        {% if images_blocked and has_external_images %}
        <div class="image-banner" id="image-banner">
            <span class="image-banner-text" id="image-banner-text">üñºÔ∏è External images are blocked for security.</span>
            <div class="image-banner-buttons">
                <button id="load-images-btn" onclick="loadImages()">Load Images</button>
                {% if sender_email %}
                <span id="trust-container">
                    <button class="trust-btn" onclick="trustSender()">Always trust this sender</button>
                </span>
                <span id="trusted-container" style="display: none;">
                    <button class="undo-btn" onclick="untrustSender()">Undo</button>
                </span>
                {% endif %}
            </div>
        </div>
        <script>
        var senderEmail = "{{ sender_email }}";

        function loadImages(skipTextUpdate) {
            var container = document.getElementById('email-content');
            if (!container) return;

            var imgs = Array.from(container.querySelectorAll('img[data-src]'));
            imgs.forEach(function(img) {
                img.src = img.getAttribute('data-src');
                img.removeAttribute('data-src');
            });

            // Hide the load button and update text, but keep trust option visible
            document.getElementById('load-images-btn').style.display = 'none';
            if (!skipTextUpdate) {
                document.getElementById('image-banner-text').textContent = '‚úì Images loaded.';
            }
        }

        function trustSender() {
            fetch('/trust-sender', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(senderEmail)
            }).then(function(response) {
                if (response.ok) {
                    document.getElementById('trust-container').style.display = 'none';
                    document.getElementById('trusted-container').style.display = 'inline';
                    document.getElementById('image-banner-text').textContent = '‚úì Images from this sender will always be loaded.';
                    document.getElementById('load-images-btn').style.display = 'none';
                    loadImages(true);
                }
            });
        }

        function untrustSender() {
            fetch('/untrust-sender', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(senderEmail)
            }).then(function(response) {
                if (response.ok) {
                    document.getElementById('trusted-container').style.display = 'none';
                    document.getElementById('trust-container').style.display = 'inline';
                    document.getElementById('image-banner-text').textContent = '‚úì Images loaded.';
                }
            });
        }
        </script>
        {% endif %}

        {% if body_html %}
            <div id="email-content">{{ body_html | safe }}</div>
        {% else %}
            <pre class="email-body">{{ body | safe }}</pre>
        {% endif %}
        </div>

        {% if attachments %}
        <div class="attachments">
            <h4>Attachments</h4>
            <ul class="attachment-list">
            {% for att in attachments %}
                <li class="attachment-item">
                    <a href="/attachment/{{ message_id }}/{{ loop.index0 }}">üìé {{ att.filename }}</a>
                    ({{ att.size }})
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

<script>
function toggleEmailMenu(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('email-menu-dropdown');
    dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('email-menu-dropdown');
    if (dropdown && dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
    }
});
</script>
{% endblock %}
