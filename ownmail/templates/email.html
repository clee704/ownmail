{% extends "base.html" %}

{% block title %}{{ subject }} - ownmail{% endblock %}

{% block content %}
    <div class="email-detail">
        <div class="email-header">
            <div class="email-header-top">
                <h2>{{ subject or '(No subject)' }}</h2>
                <div class="email-menu">
                    <button class="email-menu-btn" onclick="toggleEmailMenu(event)"><span></span><span></span><span></span></button>
                    <div class="email-menu-dropdown" id="email-menu-dropdown">
                        <a href="/raw/{{ message_id }}">Show original</a>
                        <a href="/download/{{ message_id }}">Download message</a>
                    </div>
                </div>
            </div>
            <div class="email-header-row">
                <span class="email-header-label">From:</span>
                {% if sender_name and sender_email %}
                    {{ sender_name }}
                    &lt;<a href="/search?q=from:{{ sender_email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading()">{{ sender_email }}</a>&gt;
                {% elif sender_email %}
                    <a href="/search?q=from:{{ sender_email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading()">{{ sender_email }}</a>
                {% else %}
                    {{ sender }}
                {% endif %}
            </div>
            <div class="email-header-row">
                <span class="email-header-label">To:</span>
                {% for rcpt in recipients_parsed %}
                    {% if not loop.first %}, {% endif %}
                    {% if rcpt.name and rcpt.email %}
                        {{ rcpt.name }}
                        &lt;<a href="/search?q=to:{{ rcpt.email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading()">{{ rcpt.email }}</a>&gt;
                    {% elif rcpt.email %}
                        <a href="/search?q=to:{{ rcpt.email | urlencode }}&sort=date_desc" class="clickable-header" onclick="showLoading()">{{ rcpt.email }}</a>
                    {% else %}
                        {{ rcpt.raw }}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="email-header-row">
                <span class="email-header-label">Date:</span> {{ date }}
            </div>
            {% if labels %}
            <div class="labels">
                {% for label in labels %}
                <a href="/search?q=label:{{ label | urlencode }}&sort=date_desc" class="label clickable-label" onclick="showLoading()">{{ label }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% if images_blocked and has_external_images %}
        <div class="image-banner" id="image-banner">
            <span class="image-banner-text" id="image-banner-text">üñºÔ∏è External images are blocked for security.</span>
            <div class="image-banner-buttons">
                <button id="load-images-btn" onclick="loadImages()">Load Images</button>
                {% if sender_email %}
                <span id="trust-container">
                    <button class="trust-btn" onclick="trustSender()">Always trust this sender</button>
                </span>
                <span id="trusted-container" style="display: none;">
                    <button class="undo-btn" onclick="untrustSender()">Undo</button>
                </span>
                {% endif %}
            </div>
        </div>
        <script>
        var senderEmail = "{{ sender_email }}";
        var DEBUG_RESIZE = false;
        var lastContentHeight = 0;

        // Use body.scrollHeight only to avoid feedback loop
        // (documentElement.scrollHeight can reflect the iframe's own height)
        function setIframeHeight(iframe, doc, caller) {
            var bodyH = doc.body ? doc.body.scrollHeight : 0;
            var currentH = iframe.style.height;
            if (DEBUG_RESIZE) {
                console.log('[setIframeHeight] caller:', caller, '| body.scrollHeight:', bodyH, '| lastContentHeight:', lastContentHeight, '| current iframe height:', currentH);
            }
            // Only resize if content height actually changed (avoids feedback loop)
            if (bodyH > 0 && bodyH !== lastContentHeight) {
                lastContentHeight = bodyH;
                iframe.style.height = (bodyH + 20) + 'px';
                if (DEBUG_RESIZE) console.log('[setIframeHeight] -> set to:', (bodyH + 20) + 'px');
            } else {
                if (DEBUG_RESIZE) console.log('[setIframeHeight] -> skipped (no change or h <= 0)');
            }
        }

        function loadImages(skipTextUpdate) {
            if (DEBUG_RESIZE) console.log('[loadImages] called, skipTextUpdate:', skipTextUpdate);
            var iframe = document.getElementById('email-frame');
            if (!iframe) {
                if (DEBUG_RESIZE) console.log('[loadImages] no iframe found, returning');
                return;
            }

            var doc = iframe.contentDocument;
            if (!doc) {
                if (DEBUG_RESIZE) console.log('[loadImages] no contentDocument, returning');
                return;
            }

            var imgs = Array.from(doc.querySelectorAll('img[data-src]'));
            if (DEBUG_RESIZE) console.log('[loadImages] found', imgs.length, 'images with data-src');

            imgs.forEach(function(img, idx) {
                var src = img.getAttribute('data-src');
                if (DEBUG_RESIZE) console.log('[loadImages] img', idx, 'src:', src);

                var onDone = function(evt) {
                    if (DEBUG_RESIZE) console.log('[loadImages] img', idx, 'onDone fired, event:', evt ? evt.type : 'manual (complete)', '| img.complete:', img.complete, '| naturalWidth:', img.naturalWidth, '| naturalHeight:', img.naturalHeight);
                    // Wait a frame so layout has actually updated
                    requestAnimationFrame(function() { setIframeHeight(iframe, doc, 'img-' + idx + '-' + (evt ? evt.type : 'complete')); });
                    img.removeEventListener('load', onDone);
                    img.removeEventListener('error', onDone);
                };

                // Attach listeners BEFORE setting src (to catch cached images)
                img.addEventListener('load', onDone);
                img.addEventListener('error', onDone); // still resize if broken image affects layout

                img.src = src;
                img.removeAttribute('data-src');

                // If already complete (cached), load may not fire
                if (img.complete) {
                    if (DEBUG_RESIZE) console.log('[loadImages] img', idx, 'already complete (cached)');
                    onDone(null);
                }
            });

            // One more resize after kicking off loads
            if (DEBUG_RESIZE) console.log('[loadImages] scheduling fallback resizes');
            requestAnimationFrame(function() { setIframeHeight(iframe, doc, 'loadImages-raf'); });
            setTimeout(function() { setIframeHeight(iframe, doc, 'loadImages-500ms'); }, 500);
            setTimeout(function() { setIframeHeight(iframe, doc, 'loadImages-1500ms'); }, 1500);

            // Hide the load button and update text, but keep trust option visible
            document.getElementById('load-images-btn').style.display = 'none';
            if (!skipTextUpdate) {
                document.getElementById('image-banner-text').textContent = '‚úì Images loaded.';
            }
        }

        function trustSender() {
            fetch('/trust-sender', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(senderEmail)
            }).then(function(response) {
                if (response.ok) {
                    document.getElementById('trust-container').style.display = 'none';
                    document.getElementById('trusted-container').style.display = 'inline';
                    document.getElementById('image-banner-text').textContent = '‚úì Images from this sender will always be loaded.';
                    document.getElementById('load-images-btn').style.display = 'none';
                    loadImages(true);
                }
            });
        }

        function untrustSender() {
            fetch('/untrust-sender', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'email=' + encodeURIComponent(senderEmail)
            }).then(function(response) {
                if (response.ok) {
                    document.getElementById('trusted-container').style.display = 'none';
                    document.getElementById('trust-container').style.display = 'inline';
                    document.getElementById('image-banner-text').textContent = '‚úì Images loaded.';
                }
            });
        }
        </script>
        {% endif %}

        {% if body_html %}
            <iframe id="email-frame" class="email-body-html" sandbox="allow-same-origin" srcdoc="{{ body_html | e }}"></iframe>
            <script>
            // Debug flag (may already be defined by image loading script)
            if (typeof DEBUG_RESIZE === 'undefined') var DEBUG_RESIZE = false;

            // Track last content height to avoid feedback loops (may already be defined)
            if (typeof lastContentHeight === 'undefined') var lastContentHeight = 0;

            // Robust height calculation - use body.scrollHeight only to avoid feedback loop
            // (documentElement.scrollHeight can reflect the iframe's own height)
            if (typeof setIframeHeight === 'undefined') {
                function setIframeHeight(iframe, doc, caller) {
                    var bodyH = doc.body ? doc.body.scrollHeight : 0;
                    var currentH = iframe.style.height;
                    if (DEBUG_RESIZE) {
                        console.log('[setIframeHeight] caller:', caller, '| body.scrollHeight:', bodyH, '| lastContentHeight:', lastContentHeight, '| current iframe height:', currentH);
                    }
                    // Only resize if content height actually changed (avoids feedback loop)
                    if (bodyH > 0 && bodyH !== lastContentHeight) {
                        lastContentHeight = bodyH;
                        iframe.style.height = (bodyH + 20) + 'px';
                        if (DEBUG_RESIZE) console.log('[setIframeHeight] -> set to:', (bodyH + 20) + 'px');
                    } else {
                        if (DEBUG_RESIZE) console.log('[setIframeHeight] -> skipped (no change or h <= 0)');
                    }
                }
            }

            function resizeIframe() {
                if (DEBUG_RESIZE) console.log('[resizeIframe] called');
                var iframe = document.getElementById('email-frame');
                try {
                    var doc = iframe.contentDocument;
                    if (doc) {
                        requestAnimationFrame(function() { setIframeHeight(iframe, doc, 'resizeIframe-raf'); });
                    } else {
                        if (DEBUG_RESIZE) console.log('[resizeIframe] no contentDocument');
                    }
                } catch(e) {
                    if (DEBUG_RESIZE) console.log('[resizeIframe] error:', e);
                }
            }

            function setupResizeObserver(iframe) {
                if (DEBUG_RESIZE) console.log('[setupResizeObserver] called');
                try {
                    var doc = iframe.contentDocument;
                    if (!doc || !doc.documentElement) {
                        if (DEBUG_RESIZE) console.log('[setupResizeObserver] no doc or documentElement, returning');
                        return;
                    }

                    var ro = new ResizeObserver(function(entries) {
                        if (DEBUG_RESIZE) console.log('[ResizeObserver] triggered, entries:', entries.length);
                        setIframeHeight(iframe, doc, 'ResizeObserver');
                    });
                    // Only observe body - observing documentElement causes feedback loop
                    if (doc.body) {
                        ro.observe(doc.body);
                        if (DEBUG_RESIZE) console.log('[setupResizeObserver] observing body');
                    }
                } catch(e) {
                    if (DEBUG_RESIZE) console.log('[setupResizeObserver] error:', e);
                }
            }

            function initIframe() {
                if (DEBUG_RESIZE) console.log('[initIframe] called');
                var iframe = document.getElementById('email-frame');
                resizeIframe();
                setupResizeObserver(iframe);
                setTimeout(function() { if (DEBUG_RESIZE) console.log('[initIframe] 500ms timeout'); resizeIframe(); }, 500);
                setTimeout(function() { if (DEBUG_RESIZE) console.log('[initIframe] 1500ms timeout'); resizeIframe(); }, 1500);
            }

            (function() {
                var iframe = document.getElementById('email-frame');
                // Check if iframe is already loaded (srcdoc can load synchronously)
                if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                    if (DEBUG_RESIZE) console.log('[init] iframe already loaded, calling initIframe immediately');
                    initIframe();
                } else {
                    if (DEBUG_RESIZE) console.log('[init] iframe not ready, attaching onload handler');
                    iframe.onload = function() {
                        if (DEBUG_RESIZE) console.log('[iframe.onload] fired');
                        initIframe();
                    };
                }
            })();
            </script>
        {% else %}
            <pre class="email-body">{{ body }}</pre>
        {% endif %}

        {% if attachments %}
        <div class="attachments">
            <h4>Attachments</h4>
            <ul class="attachment-list">
            {% for att in attachments %}
                <li class="attachment-item">
                    <a href="/attachment/{{ message_id }}/{{ loop.index0 }}">üìé {{ att.filename }}</a>
                    ({{ att.size }})
                </li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

<script>
function toggleEmailMenu(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('email-menu-dropdown');
    dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('email-menu-dropdown');
    if (dropdown && dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
    }
});
</script>
{% endblock %}
