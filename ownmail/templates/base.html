<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ownmail{% endblock %}</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
    // Apply theme immediately to prevent flash of wrong theme
    (function() {
        var pref = localStorage.getItem('ownmail-theme') || 'auto';
        var dark = pref === 'dark' || (pref === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (dark) document.documentElement.classList.add('ownmail-dark');
    })();
    </script>
</head>
<body>
    <div class="ownmail-loading-overlay" id="ownmail-loading-overlay">
        <div class="ownmail-loading-spinner"></div>
    </div>
    <div class="ownmail-header">
        <h1><a href="/">üì≠ ownmail</a></h1>
        <div class="ownmail-header-right">
            <span class="ownmail-stats">{{ stats.total_emails | default(0) | int }} emails archived &bull; <a href="/help">Search help</a> &bull; <a href="/settings">‚öôÔ∏è</a></span>
            <button class="ownmail-theme-toggle" id="ownmail-theme-toggle" onclick="toggleTheme()" title="Toggle theme"><span class="ownmail-theme-current">üåô</span><span class="ownmail-theme-next">‚òÄÔ∏è</span></button>
        </div>
    </div>
    {% block content %}{% endblock %}
    <script>
    // Theme: reads localStorage preference (auto/light/dark)
    function isDarkMode() {
        var pref = localStorage.getItem('ownmail-theme') || 'auto';
        return pref === 'dark' || (pref === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
    }
    function applyTheme() {
        var dark = isDarkMode();
        document.documentElement.classList.toggle('ownmail-dark', dark);
        updateThemeIcon(dark);
        if (typeof updateEmailDarkMode === 'function') updateEmailDarkMode(dark);
    }
    function updateThemeIcon(dark) {
        var btn = document.getElementById('ownmail-theme-toggle');
        if (!btn) return;
        var current = btn.querySelector('.ownmail-theme-current');
        var next = btn.querySelector('.ownmail-theme-next');
        if (!current || !next) return;
        current.textContent = dark ? 'üåô' : '‚òÄÔ∏è';
        next.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
        btn.title = dark ? 'Switch to light mode' : 'Switch to dark mode';
    }
    function toggleTheme() {
        var dark = isDarkMode();
        // Explicit override: set to opposite of current
        localStorage.setItem('ownmail-theme', dark ? 'light' : 'dark');
        applyTheme();
        // Suppress hover swap until mouse leaves, so the icon
        // correctly reflects the new state instead of previewing next
        var btn = document.getElementById('ownmail-theme-toggle');
        if (btn) {
            btn.classList.add('ownmail-theme-locked');
            btn.addEventListener('mouseleave', function unlock() {
                btn.classList.remove('ownmail-theme-locked');
                btn.removeEventListener('mouseleave', unlock);
            });
        }
    }
    // Listen for OS theme changes (matters when pref is 'auto')
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        applyTheme();
    });
    applyTheme();

    function showLoading(event) {
        // Don't show loading overlay for cmd+click or ctrl+click (new tab)
        if (event && (event.metaKey || event.ctrlKey)) {
            return;
        }
        document.getElementById('ownmail-loading-overlay').classList.add('ownmail-active');
    }
    function hideLoading() {
        document.getElementById('ownmail-loading-overlay').classList.remove('ownmail-active');
    }
    // Hide loading overlay when page is shown (handles back/forward navigation)
    // This fires when page is restored from bfcache (back-forward cache)
    window.addEventListener('pageshow', function(event) {
        hideLoading();
    });
    // Also hide on regular page load just in case
    window.addEventListener('load', function() {
        hideLoading();
    });
    // Show loading on form submit
    document.querySelectorAll('form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            showLoading(e);
        });
    });
    // Show loading on email item click
    document.querySelectorAll('.ownmail-email-item a').forEach(function(link) {
        link.addEventListener('click', function(e) {
            showLoading(e);
        });
    });
    // Show loading on pagination click
    document.querySelectorAll('.ownmail-pagination a').forEach(function(link) {
        link.addEventListener('click', function(e) {
            showLoading(e);
        });
    });
    </script>
</body>
</html>
